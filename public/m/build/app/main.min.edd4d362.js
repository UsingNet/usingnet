/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * @license RequireJS text 2.0.12 Copyright (c) 2010-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

var requirejs,require,define;(function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("../../node_modules/almond/almond",function(){}),define("pages/index/setting",[],function(){$(document).on("click",'[data-action="info-menu"]',function(){if($("#index").find("header h1").html()=="请选择工单")return $.toast("请先选择工单"),!1;var e=[{text:"客户基本信息",onClick:function(){$.popup(".popup-customer-basic")}},{text:"客户自定义信息",onClick:function(){$.popup(".popup-customer-detail")}},{text:"客服插件",onClick:function(){$.popup(".popup-customer-plugin")}},{text:"关闭工单",color:"danger",onClick:function(){$.popup(".popup-order-close")}}],t=[{text:"取消",bg:"danger"}],n=[e,t];$.actions(n)})}),define("lib/class",[],function(){var e=function(){this.eventTarget=document.createDocumentFragment(),this.addEventListener=function(e,t,n){this.eventTarget.addEventListener(e,t,n)},this.removeEventListener=function(e,t,n){this.eventTarget.removeEventListener(e,t,n)},this.dispatchEvent=function(e){this.eventTarget.dispatchEvent(e)}};return e.prototype.extend=function(e){var t=this;return function(){this.__parent=t.constructor,this.__child=e,this.__parent.apply(this,arguments),this.__child.apply(this,arguments),delete this.__parent,delete this.__child}},e}),define("lib/template",[],function(){return new function(){var _dataList=null,_scanTemplateName=0,_scanCode="",_scanCodeIndex=0,_scanCodeChar="",_scanCodeLength=0,_scanCodeLine=0,_scanCodeCol=0,_codeConditionNested=0,_codeBlockNested=0,_codeState=0,_run=function(){_scanCodeIndex=0,_scanCodeLength=_scanCode.length,_scanCodeLine=0,_scanCodeCol=0,_codeState=0;var rString='var codeString = "";try{';while(_readChar())switch(_codeState){case 1:rString+='codeString += "'+_jsStringEncode(_readHTMLBlock())+'";';break;case 3:rString+=_readJTemplate()+";"}return rString+="}catch(e){console.log(e);}",eval(rString)},_readJTemplate=function(){_codeState==2&&_readChar();var e="";do{if(_codeState==4)return _decodeVar(e).replace(/echo/g,"codeString += ");e+=_scanCodeChar}while(_readChar());throw'JTemplate code should be end with "#>".'},_readHTMLBlock=function(){_codeState==4&&_readChar();var e="",t="";do{if(t=="<"&&_scanCodeChar=="#")return e;e+=t,t=_scanCodeChar}while(_readChar());return e+=t,e},_jsStringEncode=function(e){return e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\r/ig,"").replace(/\n/ig,"\\\n")},_readChar=function(){if(_scanCodeIndex<_scanCodeLength){var e=_scanCodeChar;return _scanCodeChar=_scanCode.substr(_scanCodeIndex,1),_codeState==0?_codeState=1:_codeState==1&&e=="<"&&_scanCodeChar=="#"?_codeState=2:_codeState==2?_codeState=3:_codeState==3&&_scanCodeChar=="#"?_codeState=4:_codeState==4&&e==">"&&(_codeState=1),_scanCodeChar=="\n"?(_scanCodeLine++,_scanCodeCol=0):_scanCodeChar=="("?_codeConditionNested++:_scanCodeChar==")"?_codeConditionNested--:_scanCodeChar=="{"?_codeBlockNested++:_scanCodeChar=="}"&&_codeBlockNested--,_scanCodeIndex++,_scanCodeCol++,_codeBlockNested<0&&_codeError("Code Block Nested Error"),_codeConditionNested<0&&_codeError("Code Condition Nested Error"),!0}return _scanCodeChar="",!1},_codeError=function(e){throw"JTemplate Code Error in Template["+_scanTemplateName+"] line "+_scanCodeLine+" char "+_scanCodeCol+": "+e+"."},_decodeVar=function(e){return e.replace(/\$([a-zA-Z_]+[a-zA-Z_])*?/g,"_dataList._$1")};return function(e,t){_scanCode=e,_dataList={};if(t!=null)for(var n in t)_dataList["_"+n]=t[n];return _run()}}}),define("text",["module"],function(e){"use strict";var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.12",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.indexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1,e.length)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i&&i.isBuild&&!i.inlineText){r();return}d.isBuild=i&&i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i.indexOf("﻿")===0&&(i=i.substring(1)),t(i)}catch(s){r&&r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status||0,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r&&r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("text!template/message.html",[],function(){return'<div class="message <# echo $direction.toLowerCase() #>" data-id="<# echo $_id #>">\n    <span class="message-bubble"><# echo $body #></span>\n</div>\n<div style="clear: both"></div>'}),define("lib/websocket",["./class"],function(e){function t(e){var n;if(typeof e=="object")if(e===null)n=null;else if(e instanceof Array){n=[];for(var r=0,i=e.length;r<i;r++)n.push(t(e[r]))}else{n={};for(var s in e)n[s]=t(e[s])}else n=e;return n}return(new e).extend(function(e){var n=this,r={action:"heartbeat"},i=e||null,s=null,o=null,u={},a=[],f=0,l=function(e){if(console&&typeof console.log=="function"){console.log("WebSocket Log: ",e);var t=new Event("log");t.data=e,n.dispatchEvent(t)}},c=function(){var e=(new Date).getTime();for(var t in u)if(u[t].timeout<e){var r=new Event("timeout");u[t].callback.call(n,null,r)}};this.connect=function(e){return s?!1:(s=new WebSocket((e||i)+("&_="+Math.random())),s.addEventListener("open",function(){u={},o=setInterval(function(){n.send(r,function(e,t){t.type=="timeout"?n.close(!0):f=0},5e3),c()},2e4);var e=new Event("open");n.dispatchEvent(e);if(a.length)while(a.length)n.send.apply(n,a.shift())}),s.addEventListener("close",function(){o&&clearInterval(o);var e=new Event("close");e.reconnect=!!s,n.dispatchEvent(e),s&&(s=null,f++,setTimeout(function(){n.connect()},Math.pow(2,f)*1e3))}),s.addEventListener("error",function(e){l(e)}),s.addEventListener("message",function(e){var t=JSON.parse(e.data);t&&t.message_id&&u[t.message_id]&&(u[t.message_id].callback.call(n,t,e),delete u[t.message_id]);var r=new Event("message");r.data=t,n.dispatchEvent(r)}),!0)},this.send=function(e,n,r){var i=t(e),o=(new Date).getTime()+Math.random();return n&&typeof n=="function"&&(u[o]={callback:n,timeout:(Math.max(r,0)||2e4)+(new Date).getTime()}),i.message_id=o,s.readyState==WebSocket.OPEN?s.send(JSON.stringify(i)):a.push([e,n,r]),!0},this.close=function(e){typeof e=="undefined"&&(e=!1);if(e)s.close();else{var t=s;s=null,t.close()}return!0}})}),define("pages/index/message-box",["lib/class","lib/template","text!template/message.html","lib/websocket"],function(e,t,n,r){var i=[],s=(new e).extend(function(e){var t=this;i.push(t),t.orderData=e,t.$=$('<div class="message-box"></div>'),$.getJSON("/api/message/agent",{type:"IM",remote:e.contact.token,_:Math.random()},function(e){navigator&&navigator.appVersion&&navigator.appVersion.match("MQQBrowser")?t.conn=new r("ws://"+location.hostname.replace(/^m\./,"ws.")+"/ws?_token="+e.data):t.conn=new r("ws"+(location.protocol=="https:"?"s":"")+"://"+location.hostname.replace(/^m\./,"ws.")+"/ws?_token="+e.data),t.conn.addEventListener("message",function(e){var n=e.data;if(n.type=="event")switch(n.data.action){case"online":t.tail(!0);break;case"heartbeat":case"tail":case"offline":case"read":case"remote_online":case"remote_offline":break;default:debugger}else n.data.direction!="SEND"&&t.conn.send({action:"read",_id:n.data._id}),t.appendMessage(n.data)}),t.conn.connect()})});s.prototype.appendMessage=function(e){this.$.append(t(n,e)),$(".content")[0].scrollTop=this.$[0].scrollHeight},s.prototype.close=function(){this.conn.close(),this.$.parent().hide(),$("#index").find("header h1").html("请选择工单"),this.$.replaceWith('<div class="message-box"></div>')},s.prototype.prependHistoryMessage=function(e){if(e.length){var r="";for(var i in e)r+=t(n,e[i]);this.$.prepend(r)}else $.toast("已无更早的消息")},s.prototype.apply=function(){var e=$(".message-box");e.parent().show(),e.replaceWith(this.$[0]),$(".content")[0].scrollTop=this.$[0].scrollHeight},s.prototype.sendMessage=function(e){this.orderData.contact?$.post("/api/message/agent",{type:this.orderData.type,to:this.orderData.contact.id,body:e}):$.toast("联系人不存在")},s.prototype.tail=function(e){var t=this;this.conn.send({action:"tail",last_id:$(".message-box .message").attr("data-id"),limit:20,read:!0},function(n){t.prependHistoryMessage(n.data.messages),e?$(".content")[0].scrollTop=t.$[0].scrollHeight:$.pullToRefreshDone(".pull-to-refresh-content")})};var o=function(){var e=$(".message-box");for(var t=0;t<i.length;t++)if(e[0]==i[t].$[0])return i[t]};$(document).on("refresh",".pull-to-refresh-content",function(e){var t=o();t.tail()}),$(document).on("click",".message-box .message img",function(){var e=[];$(".message-box .message img").each(function(t,n){e.push(n.src)});var t=$.photoBrowser({photos:e});t.open()});var u=$('[data-action="message-input"]'),a=$('[data-action="send-message"]'),f=function(){var e=u.val(),t=o();t?(t.sendMessage(e),u.val(""),u.focus()):$.alert("请选择工单")};return a.click(function(){return f(),!1}),u.keypress(function(e){(e.keyCode==13||e.keyCode==10)&&f()}),s}),define("api/rest",["lib/class"],function(e){var t=(new e).extend(function(e){if(!e.url)throw"Class Rest Init need url options";this.options=$.extend({id_field:"id"},e),this.storage=[]});return t.prototype.localSearch=function(e){var t=[];for(var n=0;n<this.storage.length;n++){var r=this.storage[n];if(!r)continue;var i=!0;for(var s in e)if(r[s]!=e[s]){i=!1;break}i&&t.push(r)}return t},t.prototype.localUpdate=function(e,t){var n=!1;if(e)for(var r=0;r<this.storage.length;r++){var i=this.storage[r];if(!i)continue;var s=!0;for(var o in e)if(i[o]!=e[o]){s=!1;break}s&&(n=!0,this.storage[r]=t)}n||this.storage.push(t),this.dispatch(new Event("load"))},t.prototype.localRemove=function(e){var t=!1;if(e)for(var n=this.storage.length-1;n>=0;n--){var r=this.storage[n];if(!r)continue;var i=!0;for(var s in e)if(r[s]!=e[s]){i=!1;break}i&&(t=!0,this.storage.splice(n,1))}t&&this.dispatch(new Event("load"))},t.prototype.get=function(e,t,n,r){var i=this,s={};if(!r){s[this.options.id_field]=e;var o=this.localSearch(s)[0];if(o)return o}return $.getJSON(this.options.url+"/"+e+"?_="+Math.random(),function(e){e.success?(i.localUpdate(s,e.data),typeof t=="function"&&t(e.data)):typeof n=="function"&&n(e)})},t.prototype.post=function(e,t,n){var r=this;$.post(this.options.url,JSON.stringify(e),function(e){e.success?(r.localUpdate(null,e.data),typeof t=="function"&&t(e.data)):typeof n=="function"&&n(e)})},t.prototype.put=function(e,t,n,r){var i=this,s={};s[this.options.id_field]=e,$.ajax({url:this.options.url+"/"+e,method:"PUT",data:JSON.stringify(t),success:function(e){e.success?(i.localUpdate(s,e.data),typeof n=="function"&&n(e.data)):typeof r=="function"&&r(e)}})},t.prototype.delete=function(e){var t=this,n={};n[this.options.id_field]=e,$.ajax({url:this.options.url+"/"+e,method:"DELETE",success:function(e){e.success?(t.localRemove(n,e.data),typeof success=="function"&&success(e.data)):typeof failed=="function"&&failed(e)}})},t.prototype.list=function(e,t,n){var r=this;e._=Math.random(),$.ajax({url:this.options.url,method:"GET",data:e,success:function(i){i.success?(r.localRemove(e,i.data),typeof t=="function"&&t(i.data)):typeof n=="function"&&n(i)}})},t.prototype.sync=function(){var e=this;this.list({},function(t){this.storage=t;var n=new Event("load");n.data=this.storage,e.dispatchEvent(n)})},t}),define("api/order",["./rest"],function(e){return new e({url:"/api/order"})}),define("text!template/order-item.html",[],function(){return'<li class="item-content item-link close-panel">\n    <div class="item-inner">\n        <# echo $contact[\'name\'] #>\n        <# if($unread){ #>\n        <span class="badge"><# echo $unread #></span>\n        <# } #>\n    </div>\n</li>'}),define("lib/useragent",[],function(){var e={"5.0":"2000",5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1",6.4:"10","10.0":"10"},t={};return t.parse=function(t){t||(t="");var n="Unknown",r=null;t.indexOf("Linux")>-1?n="Linux":t.indexOf("Windows")>-1?(n="Windows",r=t.match(/Windows NT (\d+\.\d+)/),r&&r[1]&&e[r[1]]&&(n+=" "+e[r[1]])):t.indexOf("Mac OS")>-1&&(n="Mac OS",r=t.match(/Mac OS[\w\.\s_]+]/),r&&(n=r[0].replace(/_/g,".")));var i="Unknown",s="";return t.indexOf("Opera")>-1?i="Opera":t.indexOf("Chrome")>-1?i="Chrome":t.indexOf("Firefox")>-1?i="Firefox":t.indexOf("Safari")>-1?i="Safari":t.indexOf("MSIE")>-1?(i="Internet Explorer",r=t.match(new RegExp(i+" ([\\d\\.]+)")),r&&r[1]&&(s=r[1])):t.indexOf("Trident")&&(i="Internet Explorer",r=t.match(new RegExp("rv:([\\d\\.]+)")),r&&r[1]&&(s=r[1])),["Chrome","Firefox","Opera","Safari"].indexOf(i)>-1&&(r=t.match(new RegExp(i+"/([\\d\\.]+)")),r&&r[1]&&(s=r[1])),{os:n,browser:{name:i+" "+s,family:i,version:s}}},t}),define("pages/index/order-item",["lib/class","lib/template","text!template/order-item.html","./message-box","lib/useragent","api/order"],function(e,t,n,r,i,s){var o=[],u=location.search.match(/order_id=(\d+)/)?location.search.match(/order_id=(\d+)/)[1]:null,a=(new e).extend(function(e){var i=this;i.messageBox=new r(e),i.data=e,i.$=$(t(n,e)),i.$.click(function(){i.select()}),o.push(i)});return a.getSelection=function(){for(var e=0;e<o.length;e++)if(o[e].$.hasClass("selected"))return o[e]},a.findOrCreate=function(e){var t=o.filter(function(t){return t.data["id"]==e["id"]});return t[0]?t[0]:new a(e)},a.applyFirst=function(){if(u)for(var e=0;e<o.length;e++)if(o[e].data&&o[e].data.id==u)return o[e].select(),!0;return o.length>0?(o[0].select(),!0):!1},a.prototype.close=function(e){var t=this;$.ajax({url:"/api/order/"+t.data.id,type:"DELETE",data:JSON.stringify({category:e}),success:function(){t.messageBox.close(),s.sync(),location.reload()}})},a.prototype.updatePopup=function(){var e=this.data,t=$(".popup-customer-basic");t.find('[data-id="address"]').html(e.contact.package&&e.contact.package.address?e.contact.package.address:"局域网"),t.find('[data-id="ip"]').html(e.contact.package&&e.contact.package.ip?e.contact.package.ip:"未知");var n=i.parse(e.contact.package&&e.contact.package.user_agent?e.contact.package.user_agent:"");t.find('[data-id="os"]').html(n.os),t.find('[data-id="browser"]').html(n.browser.name);var r=[];for(var s=0;s<e.contact.tags.length;s++){var o=e.contact.tags[s];r.push('<span style="background:#'+o.color+'">'+o.name+"</span>")}t.find('[data-id="tags"]').html(r.join("&nbsp;"));var u=$(".popup-customer-detail");u.find('[data-id="content"').html(e.contact.html||e.contact.package&&e.contact.package.html||"系统未提供详细信息");var a=$(".popup-customer-plugin");a.find('[data-id="frame"]').attr("src",e.contact.iframe||e.contact.package&&e.contact.package.iframe||"about:blank")},a.prototype.select=function(){this.$.hasClass("selected")||(this.$.siblings().removeClass("selected"),this.$.addClass("selected"),this.messageBox.apply(),$(".page-current header h1").html("正在与 "+this.data.contact.name+"对话"),u=this.data.id,this.updatePopup())},a}),define("pages/index/order",["api/order","./order-item"],function(e,t){var n=$('[data-action="order-list"]');e.addEventListener("load",function(e){n.empty();if(e.data.length==0)$.toast("暂无工单");else{for(var r=0;r<e.data.length;r++){var i=t.findOrCreate(e.data[r]);n.append(i.$)}$.toast("工单已刷新")}t.applyFirst()}),$(document).on("click",'[data-action="order-refresh"]',function(){e.sync()}),$.getJSON("/api/order/category",{_:Math.random()},function(e){var n=$(".popup-order-close"),r=n.find('[data-id="category"]');r.empty(),r.append('<option selected="selected">请选择...</option>');for(var i=0;i<e.data.length;i++){var s=e.data[i];r.append('<option name="'+s.title+'">'+s.title+"</option>")}n.find('[data-action="close-order"]').click(function(){var e=t.getSelection();e&&e.close(r.val())})}),e.sync()}),define("pages/index/main",["./setting","./message-box","./order"],function(){var e=$(".web_online"),t={},n=function(){$.getJSON("/api/online",function(n){if(n.success)for(var r=0;r<n.data.length;r++)n.data[r].id==t.id&&e.show()})};$.getJSON("/api/me",function(e){e.success?(t=e.data,setInterval(n,6e5),n()):$.toast(e.msg)}),$(".popup-function-pc .content button").click(function(){$.post("/api/online",{action:"offline",type:"pc"},function(n){var n=JSON.parse(n);n.success?n.data.request_count?($.showPreloader("正在通知PC端离线"),setTimeout(function(){$.hidePreloader(),$.getJSON("/api/online",function(n){if(n.success){var r=!1;for(var i=0;i<n.data.length;i++)n.data[i].id==t.id&&(r=!0);r?(e.show(),$.toast("PC端未能成功离线，请稍后重试")):(e.hide(),$.toast("PC端已离线"),$.closeModal(".popup-function-pc"))}})},3e3)):($.toast("PC端已离线"),$.closeModal(".popup-function-pc")):$.toast(n.msg)})})}),requirejs(["pages/index/main"],function(){$.init()}),define("main",function(){});